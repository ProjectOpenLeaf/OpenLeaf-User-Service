name: Deploy Infrastructure to GKE

on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches: [ main ]
    paths:
      - 'k8s/k8s-infrastructure-deployment.yaml'
      - 'k8s/k8s-gke-ingress.yaml'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_REGION: ${{ secrets.GKE_REGION }}

jobs:
  deploy-infrastructure:
    name: Deploy PostgreSQL, RabbitMQ, Keycloak
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install GKE auth plugin
        run: gcloud components install gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region=${{ env.GKE_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }}

      - name: Create namespace
        run: kubectl create namespace openleaf --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy infrastructure
        run: kubectl apply -f k8s/k8s-infrastructure-deployment.yaml

      - name: Wait for databases
        run: |
          echo "â³ Waiting for databases..."
          kubectl wait --for=condition=ready pod -l app=postgres-users -n openleaf --timeout=600s
          kubectl wait --for=condition=ready pod -l app=postgres-journal -n openleaf --timeout=600s
          kubectl wait --for=condition=ready pod -l app=postgres-assignment -n openleaf --timeout=600s
          kubectl wait --for=condition=ready pod -l app=postgres-scheduling -n openleaf --timeout=600s
          echo "âœ… Databases ready!"

      - name: Wait for RabbitMQ
        run: |
          kubectl wait --for=condition=available deployment/rabbitmq -n openleaf --timeout=300s
          echo "âœ… RabbitMQ ready!"

      - name: Wait for Keycloak
        run: |
          kubectl wait --for=condition=available deployment/keycloak -n openleaf --timeout=300s
          echo "âœ… Keycloak ready!"

      - name: Deploy Ingress
        run: kubectl apply -f k8s/k8s-gke-ingress.yaml

      - name: Show infrastructure status
        run: |
          echo "### Infrastructure Status ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pods:**" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n openleaf >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services:**" >> $GITHUB_STEP_SUMMARY
          kubectl get svc -n openleaf >> $GITHUB_STEP_SUMMARY